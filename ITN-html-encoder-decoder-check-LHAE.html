<html>
  <head>
    <style>
      table, th, td {
        border: 1px solid black;
      }
      th {
        text-align: left;
      }
    </style>
  <title>DisplayPort Status for ITN ENA-340 Encoders</title>
</head>

<script type="text/javascript">
  function readTextFile(file) {
    var rawtext;
    const rawFile = new XMLHttpRequest();
    rawFile.open("GET", file, false);
    rawFile.onreadystatechange = function () {
      if (rawFile.readyState === 4) {
        if (rawFile.status === 200 || rawFile.status == 0) {
          rawtext = rawFile.responseText;
        }
      }
    }
    rawFile.send(null);
    return {
      content: rawtext,
      date: rawFile.getResponseHeader('Last-Modified')
    }
  }

  function createEntry(value, className) {
    var td = document.createElement("td");
    td.className = className;
    var p = document.createElement("p");
    p.innerHTML = value;
    td.appendChild(p);
    return td;
  }

  function createEncoderTable(data) {
    const sources = JSON.parse(readTextFile('encoders.json').content);

    sources.forEach(source => {
      const row = document.createElement("tr");

      row.appendChild(createEntry(source.id));
      row.appendChild(createEntry(source.unit));
      row.appendChild(createEntry(source.name));

      const device = data.Sources.find(e => e.id == source.id);

      if (device) {
        var resolution = document.createElement("td");
        var res = document.createElement("p");
        if (device.config.connected) {
          resolution.style.backgroundColor = '#00ff00';
        }
        else if (!device.config.connected) {
          resolution.style.backgroundColor = '#FF0000';
        }
        res.innerHTML = device.config.resolution;
        resolution.appendChild(res);
        row.appendChild(resolution);
        
        var deviceid = document.createElement("td");
        var did = document.createElement("p");
        did.innerHTML = device.deviceId;
        deviceid.appendChild(did);
        row.appendChild(deviceid);
      
        var traininginfo = document.createElement("td");
        var tinfo = document.createElement("p");
        tinfo.innerHTML = device.config.traininginfo;
        traininginfo.appendChild(tinfo);
        row.appendChild(traininginfo);
      }
      else{
        var nothfoundth = document.createElement("td");
        var notfoundp = document.createElement("p");
        notfoundp.innerHTML = "Not Found in List";
        nothfoundth.appendChild(notfoundp);
        nothfoundth.colspan = 3;
        row.appendChild(nothfoundth);
      }
      
      document.getElementById("sourcetable").appendChild(row);
    });
  }

  function createDecoderTable(data) {
    const destinations = JSON.parse(readTextFile('decoders.json').content);
    destinations.forEach(destination => {
      var row = document.createElement("tr");
      
      row.appendChild(createEntry(destination.id));
      row.appendChild(createEntry(destination.unit));
      row.appendChild(createEntry(destination.name));
      
      var device = data.Destinations.find(e => e.id == destination.id);
      
      if(device){
        var resolution = document.createElement("td");
        var res = document.createElement("p");
        if (device.config.connected) resolution.style.backgroundColor = '#00ff00';
        else if (!device.config.connected) resolution.style.backgroundColor = '#FF0000';
        res.innerHTML = device.config.resolution;
        resolution.appendChild(res);
        row.appendChild(resolution);
        
        var deviceid = document.createElement("td");
        var did = document.createElement("p");
        did.innerHTML = device.deviceId;
        deviceid.appendChild(did);
        row.appendChild(deviceid);
        
        var genlocked = document.createElement("td");
        var gl = document.createElement("p");
        if (device.config.genlocked) gl.style.backgroundColor = '#00ff00';
        else if (!device.config.genlocked) gl.style.backgroundColor = '#FF0000';
        gl.innerHTML = device.config.state;
        genlocked.appendChild(gl);
        row.appendChild(genlocked);
        
        var deviceedid = document.createElement("td");
        var edid = document.createElement("p");
        edid.innerHTML = device.config['Edid preferred Timing'];
        deviceedid.appendChild(edid);
        row.appendChild(deviceedid);
        
        var devicedisplay = document.createElement("td");
        var displaymodel = document.createElement("p");
        displaymodel.innerHTML = device.config.display[0].model;
        devicedisplay.appendChild(displaymodel);
        row.appendChild(devicedisplay);
        
        var deviceglsource= document.createElement("td");
        var genlocksource = document.createElement("p");
        genlocksource.innerHTML = device.config['genlock source'];
        deviceglsource.appendChild(genlocksource);
        row.appendChild(deviceglsource);
      
        var traininginfo = document.createElement("td");
        var tinfo = document.createElement("p");
        tinfo.innerHTML = device.config.traininginfo;
        traininginfo.appendChild(tinfo);
        row.appendChild(traininginfo);
      }
      else{
        var nothfoundth = document.createElement("td");
        var notfoundp = document.createElement("p");
        notfoundp.innerHTML = "Not Found in List";
        nothfoundth.appendChild(notfoundp);
        nothfoundth.colspan = 7;
        row.appendChild(nothfoundth);
      }
      
      document.getElementById("destinationtable").appendChild(row);
    });
  }

  function updatePage() {
    // Setting the encoders part of the page
    const encodersText = readTextFile('encoders.txt');
    const encodersData = JSON.parse(encodersText.content);
    createEncoderTable(encodersData);

    var encoderDate = document.createElement("p");
    encoderDate.innerHTML = encodersData.date;
    document.getElementById("sourcedate").appendChild(encoderDate);


    // Settings the decoders part of the page
    const decodersText = readTextFile('decoders.txt');
    const decodersData = JSON.parse(decodersText.content);
    var date = document.createElement("p");
    date.innerHTML = decodersData.date;
    document.getElementById("destinationdate").appendChild(date);

    createDecoderTable(decodersData);
  }
</script>

<body onLoad="updatePage()">
  <h1>DisplayPort Status for ITN ENA-340 Decoders</h1>
  <h2 id="destinationdate"></h2>
  <table id="destinationtable">
    <tr>
      <th><p>ID</p></th>
      <th><p>Name</p></th>
      <th><p>Unit</p></th>
      <th><p>Resolution/Connected</p></th>
      <th><p>Device ID</p></th>
      <th><p>State/Genlocked</p></th>
      <th><p>Preferred EDID</p></th>
      <th><p>Display Model</p></th>
      <th><p>Genlock Source</p></th>
      <th><p>Training Info</p></th>
    </tr>
  </table>
  <h1>DisplayPort Status for ITN ENA-340 Encoders</h1>
  <h2 id="sourcedate"></h2>
  <table id="sourcetable">
    <tr>
      <th><p>ID</p></th>
      <th><p>Unit</p></th>
      <th><p>Name</p></th>
      <th><p>Resolution/Connected</p></th>
      <th><p>Device ID</p></th>
      <th><p>Training Info</p></th>
  </table>
</body>
</html>

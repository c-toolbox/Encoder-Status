<html>
  <head>
    <style>
      :root {
        --fail-color: #a52020;
        --genlock-color: #808020;
        --training-color: #156565;

        --background-color: #222222;
        --background-color-heading: #333333;
        --text-color: #ececec;

        background-color: var(--background-color);
        color: var(--text-color);
      }

      .disconnected {
        background-color: var(--fail-color);
      }

      .notgenlocked {
        background-color: var(--genlock-color);
      }

      .trainingfail {
        background-color: var(--training-color);
      }

      div.heading {
        font-size: 48px;
        font-variant: small-caps;
      }

      div.date {
        font-size: 18px;
        font-variant: small-caps;
      }

      div.legend {
        border: 1px solid black;
        position: fixed;
        right: 25;
        top: 25;
        text-align: left;
        font-size: 18px;
      }

      div.legend * {
        padding: 5px 10px;
      }

      table {
        width: 100%;
        font-size: 14px;
      }

      th {
        font-size: 18px;
        font-variant: small-caps;
      }

      tr.spacing {
        font-size: 18px;
        background-color: var(--background-color-heading);
      }

      td {
        border-bottom: 1px solid #999999;
      }
    </style>
  <title>DisplayPort Status for ITN ENA-340 Encoders</title>
  <meta http-equiv="refresh" content="60;url=/barco/"/>
</head>

<script type="text/javascript">
  function readTextFile(file) {
    var content;
    const f = new XMLHttpRequest();
    f.open("GET", file, false);
    f.onreadystatechange = function () {
      if (f.readyState === 4 && (f.status === 200 || f.status == 0)) {
        content = f.responseText;
      }
    }
    f.send(null);
    return {
      content: content,
      date: f.getResponseHeader('Last-Modified')
    }
  }

  function createEntry(value) {
    var td = document.createElement('td');
    td.innerHTML = value;
    return td;
  }

  function createSpacing(text) {
    const row = document.createElement('tr');
    row.className = 'spacing';
    const td = document.createElement('td');
    td.colSpan = 10;
    td.innerHTML = text;
    row.appendChild(td);
    return row;
  }

  function createEncoderTable(data) {
    function addEncoder(encoder, table, checkTraining) {
      const row = document.createElement('tr');
      row.appendChild(createEntry(encoder.id));
      row.appendChild(createEntry(encoder.unit));
      row.appendChild(createEntry(encoder.name));

      const device = data.Sources.find(e => e.id == encoder.id);
      if (device) {
        if (checkTraining) {
          const TestString = 'Link trained; Bit per color component : 8; Current LaneCount: 4; Current LinkRate : 20 (HBR2);';
          if (device.config.traininginfo.substring(0, TestString.length) !== TestString) {
            row.className = 'trainingfail';
          }
        }

        if (device.config.connected != null && !device.config.connected) {
          row.className = 'disconnected';
        }
        row.appendChild(createEntry(device.config.resolution));
        row.appendChild(createEntry(device.deviceId));
        row.appendChild(createEntry(device.config.traininginfo));
      }
      else {
        row.className = 'disconnected';
        const td = document.createElement('td');
        td.colspan = 3;
        td.innerHTML = 'Not Found in List';
        row.appendChild(td);
      }
      table.appendChild(row);
    }

    let sources = JSON.parse(readTextFile('encoders.json').content);

    // Bravo system
    const bravos = sources.filter(d => d.system === 'Bravo');
    sources = sources.filter(d => d.system !== 'Bravo');

    // Watchout system
    const watchouts = sources.filter(d => d.system === 'Watchout');
    sources = sources.filter(d => d.system !== 'Watchout');

    // Fishy system
    const fishys = sources.filter(d => d.system === 'Fishy');
    sources = sources.filter(d => d.system !== 'Fishy');

    // Alpha system
    const alphas  = sources.filter(d => d.system === 'Alpha');
    sources = sources.filter(d => d.system !== 'Alpha');

    const table = document.getElementById('sourcetable');
    table.appendChild(createSpacing('Bravo'));
    bravos.forEach(d => addEncoder(d, table, true));
    table.appendChild(createSpacing('Watchout'));
    watchouts.forEach(d => addEncoder(d, table));
    table.appendChild(createSpacing('Sushi & Fishy'));
    fishys.forEach(d => addEncoder(d, table));
    table.appendChild(createSpacing('Alpha'));
    alphas.forEach(d => addEncoder(d, table));
    if (sources.length > 0) {
      table.appendChild(createSpacing('Other'));
      sources.forEach(d => addEncoder(d, table));
    }
  }

  function createDecoderTable(data) {
    function addDecoder(decoder, table) {
      const row = document.createElement('tr');

      row.appendChild(createEntry(decoder.id));
      row.appendChild(createEntry(decoder.unit));
      row.appendChild(createEntry(decoder.name));

      const device = data.Destinations.find(e => e.id == decoder.id);
      if (device) {
        if (device.config.genlocked != null && !device.config.genlocked) {
          row.className = 'notgenlocked';
        }
        if (device.config.connected != null && !device.config.connected) {
          row.className = 'disconnected';
        }
        row.appendChild(createEntry(device.config.resolution));
        row.appendChild(createEntry(device.deviceId));
        row.appendChild(createEntry(device.config.state, device.config.genlocked));
        row.appendChild(createEntry(device.config['Edid preferred Timing']));
        row.appendChild(createEntry(device.config.display[0].model));
        row.appendChild(createEntry(device.config['genlock source']));
        row.appendChild(createEntry(device.config.traininginfo));
      }
      else {
        const td = document.createElement('td');
        td.colspan = 7;
        td.innerHTML = 'Not Found in List';
        row.appendChild(td);
      }
      document.getElementById('destinationtable').appendChild(row);
    }

    let destinations = JSON.parse(readTextFile('decoders.json').content);
    // Projectors
    const projectors = destinations.filter(d => d.group === 'projector');
    destinations = destinations.filter(d => d.group !== 'projector');

    // Booth monitors
    const booths = destinations.filter(d => d.group === 'booth');
    destinations = destinations.filter(d => d.group !== 'booth');

    // Serverroom monitors
    const serverroom = destinations.filter(d => d.group === 'serverroom');
    destinations = destinations.filter(d => d.group !== 'serverroom');

    // Offices
    const offices  = destinations.filter(d => d.group === 'offices');
    destinations = destinations.filter(d => d.group !== 'offices');

    const table = document.getElementById('destinationtable');
    table.appendChild(createSpacing('Projectors'));
    projectors.forEach(d => addDecoder(d, table));
    table.appendChild(createSpacing('Booth Monitors'));
    booths.forEach(d => addDecoder(d, table));
    table.appendChild(createSpacing('Serverroom Monitors'));
    serverroom.forEach(d => addDecoder(d, table));
    table.appendChild(createSpacing('Office Monitors'));
    offices.forEach(d => addDecoder(d, table));
    if (destinations.length > 0) {
      table.appendChild(createSpacing('Other'));
      destinations.forEach(d => addDecoder(d, table));
    }
  }

  function updatePage() {
    // Setting the encoders part of the page
    const encodersText = readTextFile('.sources.txt');
    const encodersData = JSON.parse(encodersText.content);
    createEncoderTable(encodersData);

    var encoderDate = document.createElement('p');
    encoderDate.innerHTML = encodersText.date;
    document.getElementById('sourcedate').appendChild(encoderDate);


    // Settings the decoders part of the page
    const decodersText = readTextFile('.destinations.txt');
    const decodersData = JSON.parse(decodersText.content);
    var date = document.createElement('p');
    date.innerHTML = decodersText.date;
    document.getElementById('destinationdate').appendChild(date);

    createDecoderTable(decodersData);
  }
</script>

<body onLoad="updatePage()">
  <div class="legend">
    <div class="disconnected">Not connected</div>
    <div class="notgenlocked">No genlock</div>
    <div class="trainingfail">Training failure</div>
  </div>
  <div class="heading">DisplayPort Status for ITN ENA-340 Decoders</div>
  <div class="date" id="destinationdate"></div>
  <table id="destinationtable">
    <tr>
      <th><p>ID</p></th>
      <th><p>Name</p></th>
      <th><p>Unit</p></th>
      <th><p>Resolution/Connected</p></th>
      <th><p>Device ID</p></th>
      <th><p>State/Genlocked</p></th>
      <th><p>Preferred EDID</p></th>
      <th><p>Display Model</p></th>
      <th><p>Genlock Source</p></th>
      <th><p>Training Info</p></th>
    </tr>
  </table>
  <br />
  <div class="heading">DisplayPort Status for ITN ENA-340 Encoders</div>
  <div class="date" id="sourcedate"></div>
  <table id="sourcetable">
    <tr>
      <th><p>ID</p></th>
      <th><p>Unit</p></th>
      <th><p>Name</p></th>
      <th><p>Resolution/Connected</p></th>
      <th><p>Device ID</p></th>
      <th><p>Training Info</p></th>
  </table>
</body>
</html>
